name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            lib_name: libAssetManager.so

          - platform: windows
            os: windows-latest
            target: x86_64-pc-windows-msvc
            lib_name: AssetManager.dll

          - platform: macos
            os: macos-latest
            target: x86_64-apple-darwin
            lib_name: libAssetManager.dylib

          - platform: macos-arm64
            os: macos-latest
            target: aarch64-apple-darwin
            lib_name: libAssetManager.dylib

          - platform: android-arm64
            os: ubuntu-latest
            target: aarch64-linux-android
            lib_name: libAssetManager.so

          - platform: android-x86_64
            os: ubuntu-latest
            target: x86_64-linux-android
            lib_name: libAssetManager.so

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Android NDK
        if: startsWith(matrix.platform, 'android')
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26d
          add-to-path: true

      - name: Configure Android environment
        if: startsWith(matrix.platform, 'android')
        run: |
          echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang" >> $GITHUB_ENV
          echo "CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi34-clang" >> $GITHUB_ENV
          echo "CARGO_TARGET_X86_64_LINUX_ANDROID_LINKER=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android34-clang" >> $GITHUB_ENV
          echo "CC_aarch64_linux_android=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang" >> $GITHUB_ENV
          echo "CC_armv7_linux_androideabi=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi34-clang" >> $GITHUB_ENV
          echo "CC_x86_64_linux_android=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android34-clang" >> $GITHUB_ENV
          echo "AR_aarch64_linux_android=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" >> $GITHUB_ENV
          echo "AR_armv7_linux_androideabi=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" >> $GITHUB_ENV
          echo "AR_x86_64_linux_android=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" >> $GITHUB_ENV

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: rust/target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        working-directory: rust
        run: cargo build --release --target ${{ matrix.target }}

      - name: Prepare artifact (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p artifact
          cp rust/target/${{ matrix.target }}/release/${{ matrix.lib_name }} artifact/

      - name: Prepare artifact (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir artifact
          copy rust\target\${{ matrix.target }}\release\${{ matrix.lib_name }} artifact\

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.target }}
          path: artifact/${{ matrix.lib_name }}
          retention-days: 1

  package:
    name: Package addon
    needs: build
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create bin directory
        run: mkdir -p addons/local_assets/bin

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize libraries
        run: |
          mkdir -p addons/local_assets/bin

          # Linux
          cp artifacts/linux-x86_64-unknown-linux-gnu/libAssetManager.so addons/local_assets/bin/libAssetManager.linux.x86_64.so

          # Windows
          cp artifacts/windows-x86_64-pc-windows-msvc/AssetManager.dll addons/local_assets/bin/libAssetManager.windows.x86_64.dll

          # macOS - Create universal binary
          lipo -create \
            artifacts/macos-x86_64-apple-darwin/libAssetManager.dylib \
            artifacts/macos-arm64-aarch64-apple-darwin/libAssetManager.dylib \
            -output addons/local_assets/bin/libAssetManager.macos.framework

          # Android
          cp artifacts/android-arm64-aarch64-linux-android/libAssetManager.so addons/local_assets/bin/libAssetManager.android.arm64.so
          cp artifacts/android-x86_64-x86_64-linux-android/libAssetManager.so addons/local_assets/bin/libAssetManager.android.x86_64.so

      - name: Copy .gdextension file
        run: |
          # The .gdextension file is already in the repo at addons/local_assets/bin/AssetManager.gdextension
          # It will be included automatically when we zip the addon folder
          echo "Using existing .gdextension file from repository"

      - name: Create addon zip
        run: |
          cd addons
          zip -r ../local_assets_addon.zip local_assets/
          cd ..

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=manual-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release (Tag)
        if: github.event_name != 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          files: local_assets_addon.zip
          body: |
            ## Local Assets Browser Addon

            ### Installation
            1. Download `local_assets_addon.zip`
            2. Extract the `local_assets` folder to your Godot project's `addons/` directory
            3. Enable the plugin in Project Settings > Plugins

            ### Platforms Supported
            - **Editor:** Linux, Windows, macOS (universal binary)
            - **Android:** arm64-v8a, x86_64

            ### Changes
            Auto-generated release from tag ${{ steps.get_version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact (Manual)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: local_assets_addon-${{ steps.get_version.outputs.version }}
          path: local_assets_addon.zip
          retention-days: 30
